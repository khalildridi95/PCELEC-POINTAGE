<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>PCELEC</title>
    <style>
      :root{--primary:#1976d2;--muted:#6b7280;--bg:#fafafa;--card:#fff;--radius:8px;}

      /* Scroll global */
      html{min-height:100%;overflow-x:hidden;overflow-y:auto;}
      html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#111;}
      body{
        min-height:100%;
        margin:0;
        overflow-y:auto;
        -webkit-overflow-scrolling:touch;
        overscroll-behavior-y:contain;
        touch-action:pan-y;
        font-size:48px;
      }

      .container{width:100%;max-width:none;margin:0;padding:40px;margin-bottom:200px;box-sizing:border-box;}
      h2{margin:0 0 32px 0;color:var(--primary);font-size:60px;}
      label{display:block;margin-top:24px;font-size:48px;color:#333;}
      select,input[type="time"],input[type="text"],input[type="password"],textarea{display:block;width:100%!important;padding:20px;border:2px solid #e5e7eb;border-radius:12px;font-size:48px;background:#fff;box-sizing:border-box;-webkit-text-size-adjust:100%;}
      textarea{min-height:200px;}
      .card{background:var(--card);border-radius:var(--radius);padding:36px;box-shadow:0 12px 32px rgba(16,24,40,0.06);margin-bottom:36px;}
      .muted{color:var(--muted);font-size:42px;}
      .actions{display:flex;gap:20px;margin-top:32px;flex-wrap:wrap;}
      button{background:var(--primary);color:#fff;border:none;padding:20px 30px;border-radius:16px;font-weight:600;cursor:pointer;font-size:48px;min-height:80px;}
      button.secondary{background:#666;}
      .small{padding:16px 24px;font-size:42px;min-height:72px;}
      .hidden{display:none}
      .error-text{color:#b91c1c;font-size:42px;margin-top:16px;display:none;}
      .fixed-footer{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:space-between;align-items:center;gap:16px;z-index:40;padding:20px;padding-bottom:calc(20px + env(safe-area-inset-bottom));}
      .fixed-footer.hidden{display:none}
      .footer-left{display:flex;gap:16px;align-items:center;}
      .footer-right{color:var(--muted);font-size:36px;}

      /* Historique */
      #historyPanel{
        position:fixed;left:0;right:0;bottom:160px;
        max-height:calc(100vh - 160px);
        background:var(--card);
        border-radius:20px;
        padding:32px;
        box-shadow:0 36px 120px rgba(2,6,23,0.2);
        overflow:auto;
        overscroll-behavior:none;
        display:none;z-index:50;
        padding-bottom:calc(32px + env(safe-area-inset-bottom));
        font-size:10px;
        touch-action:pan-y;
      }
      #historyHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;margin-top: 100px;}
      /* barre de scroll horizontale en haut */
.h-scrollbar{
  position:sticky;
  top:0;
  z-index:5;
  height:16px;
  background:#f1f5f9;
  overflow-x:auto;
  overflow-y:hidden;
  scrollbar-gutter:stable both-edges;
}
.h-scrollbar-inner{height:1px;}
.table-wrap{overflow:auto;max-height:calc(100vh - 240px);-webkit-overflow-scrolling:touch;overscroll-behavior:none;width:100%;transform:translateZ(0);margin-bottom:300px;}
table{min-width: 100%;border-collapse:collapse;font-size:26px;width:auto;padding-bottom:100px;}
th,td{border:14px solid #eee;padding:18px;text-align:left}
tbody tr:nth-child(odd){background:#ffffff;}
tbody tr:nth-child(even){background:#e0f2ff;}
th{background:#fbfbfb;position:sticky;top:0}
.entry-block{border:2px dashed #ddd;padding:20px;border-radius:12px;margin-top:20px;}
.entry-actions{display:flex;gap:16px;margin-top:20px;flex-wrap:wrap;}
.chantier-block{border:2px dashed #ddd;padding:20px;border-radius:12px;margin-top:20px;}
.deplacement-block{border:2px dashed #ddd;padding:20px;border-radius:12px;margin-top:20px;}
.interim-block{border:2px dashed #cbd5e1;padding:20px;border-radius:12px;margin-top:20px;background:#fff;}
.interim-actions{display:flex;gap:16px;margin-top:20px;align-items:center;}
@media (max-width:768px){.container{padding:32px;margin-bottom:180px;}button,.small{padding:18px 26px;font-size:48px;min-height:76px;}.muted{font-size:42px;}.error-text{font-size:42px;}.status-text{font-size:48px;}h2{font-size:56px;}label{font-size:48px;}}
.msg{margin-top:24px;color:green;font-size:42px}
.inline{display:inline-block;margin-right:16px;}
.status-text{font-weight:700;font-size:42px;margin-left:16px;}
.status-green{color:#059669;}
.status-red{color:#b91c1c;}
    </style>
  </head>

  <body>
    <div class="container">
      <div style="text-align:center;margin-bottom:32px;">
        <img id="appLogo" alt="appLogo" style="height:240px;max-width:100%;display:none;">
      </div>

      <div id="page-login" class="card" aria-live="polite">
        <h2>Connexion</h2>

        <label for="login">Identifiant
          <select id="login" aria-label="identifiant"></select>
        </label>
        <div id="err_login" class="error-text"></div>

        <label for="password">Mot de passe
          <input type="password" id="password" autocomplete="current-password">
        </label>
        <div id="err_password" class="error-text"></div>

        <div class="actions">
          <button id="btnLogin" onclick="seConnecter()" class="small">Se connecter</button>
        </div>

        <div id="login-msg" class="error-text" style="display:none;margin-top:20px"></div>
      </div>

      <div id="page-form" class="card hidden" style="padding-bottom:48px">
        <h2>Pointage</h2>
        <div class="muted">Utilisateur connecté : <b id="userLabel"></b><br><span id="matriculeDisplay" class="muted"></span></div>
        <div id="err_global" class="error-text"></div>

        <label>Type
          <select id="typePersonne" onchange="majTypePersonne()">
            <option value="">-- Choisir --</option>
            <option value="salarie">Salarié</option>
            <option value="interimaire">Intérimaire</option>
          </select>
        </label>
        <div id="err_typePersonne" class="error-text"></div>

        <div id="form-sections" class="hidden">
          <div id="bloc-interimaire" class="hidden">
            <div id="interimContainer" style="margin-top:24px"></div>

            <div class="interim-actions" style="margin-top:24px;">
              <button class="small" onclick="ajouterInterimaire()">Ajouter intérimaire</button>
            </div>
          </div>

          <div id="entries-section" class="hidden">
            <div id="entriesContainer"></div>
            <div class="entry-actions">
              <div id="loadingIndicator" style="display:none;color:var(--muted);font-size:32px;margin-right:16px;">Ajout en cours...</div>
              <button class="small" onclick="ajouterChantier()">Ajouter un chantier</button>
              <button class="small" onclick="ajouterDeplacement()">Ajouter déplacement</button>
            </div>
            <div id="err_entries" class="error-text"></div>
          </div>

          <div class="actions" style="margin-top:32px;">
            <button id="btnValider" onclick="valider()" class="small">Valider</button>
            <span id="transferStatus" class="status-text"></span>
            <div class="msg" id="msg"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="historyPanel" aria-hidden="true">
      <div id="historyHeader" style="margin-top: 100px;">
        <strong id="historyTitle" style="font-size:48px;">Historique</strong>

        <div>
          <button id="btnExportCSV" onclick="telechargerCSV()" style="padding:8px 12px; font-size:32px; min-height:40px;">Exporter CSV</button>
          <button id="btnExportPDF" onclick="telechargerPDF()" style="padding:8px 12px; font-size:32px; min-height:40px;">Exporter PDF</button>
          <button class="secondary" onclick="fermerHistorique()" style="padding:8px 12px; font-size:32px; min-height:40px;">Fermer</button>
        </div>
      </div>
      <div id="historyContent" style="padding-top: 40px;"><div class="muted">Chargement...</div></div>
    </div>

    <div id="fixedFooter" class="fixed-footer hidden" aria-hidden="true">
      <div class="footer-left">
        <button id="btnShowHistory" onclick="afficherHistorique()" style="font-size:36px;padding:12px 20px;min-height:60px;">Afficher l'historique</button>
      </div>
      <div class="footer-right" id="appCredit">PCELEC</div>
    </div>

    <template id="interimTpl">
      <div class="interim-block">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong class="interim-title">Intérimaire</strong>
          <button class="small" onclick="supprimerInterimaire(this)">Supprimer</button>
        </div>
        <label>Nom <input type="text" class="it_nom"></label>
        <div class="error-text it_err_nom" style="display:none;"></div>

        <label>Camping <select class="it_camping" onchange="majAffairesInterimaireBlock(this)"></select></label>
        <div class="error-text it_err_camping" style="display:none;"></div>

        <label>Affaire <select class="it_affaire"></select></label>
        <div class="error-text it_err_affaire" style="display:none;"></div>

        <label>Tâche réalisée <textarea class="it_tache"></textarea></label>
        <div class="error-text it_err_tache" style="display:none;"></div>

        <label>Heure début <input type="time" class="it_debut"></label>
        <div class="error-text it_err_debut" style="display:none;"></div>
        <label>Heure fin <input type="time" class="it_fin"></label>
        <div class="error-text it_err_fin" style="display:none;"></div>
      </div>
    </template>

    <template id="chantierTpl">
      <div class="chantier-block">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <strong class="chantier-title">Chantier</strong>
          <button class="small" onclick="supprimerEntry(this)">Supprimer</button>
        </div>
        <label>Camping
          <select class="mc_camping" onchange="majAffairesChantier(this)"></select>
        </label>
        <div class="error-text mc_err_camping" style="display:none;"></div>

        <label>Affaire
          <select class="mc_affaire"></select>
        </label>
        <div class="error-text mc_err_affaire" style="display:none;"></div>

        <label>Tâche réalisée
          <textarea class="mc_tache"></textarea>
        </label>
        <div class="error-text mc_err_tache" style="display:none;"></div>

        <label>Heure début
          <input type="time" class="mc_heureDebut">
        </label>
        <div class="error-text mc_err_debut" style="display:none;"></div>

        <label>Heure fin
          <input type="time" class="mc_heureFin">
        </label>
        <div class="error-text mc_err_fin" style="display:none;"></div>

        <div style="margin-top:16px;">
          <button class="small" onclick="ajouterPauseChantier(this)">Ajouter pause</button>
        </div>
      </div>
    </template>

    <template id="deplacementTpl">
      <div class="deplacement-block">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <strong class="deplacement-title">Déplacement</strong>
          <button class="small" onclick="supprimerEntry(this)">Supprimer</button>
        </div>
        <label>Type:
          <select class="dtype">
            <option value="domicile">Domicile</option>
            <option value="travail">Travail</option>
          </select>
        </label>
        <label>Commentaire: <input class="d-comment" type="text" required></label>
        <div class="error-text d_err_comment" style="display:none;"></div>
        <label>Début: <input class="d-debut" type="time"></label>
        <div class="error-text d_err_debut" style="display:none;"></div>
        <label>Fin: <input class="d-fin" type="time"></label>
        <div class="error-text d_err_fin" style="display:none;"></div>
      </div>
    </template>

    <script>
      let campingsAffaires = [];
      let currentUser = '';
      let currentMatricule = '';
      let cachedHistory = null;

      window.onload = function(){





        document.getElementById('fixedFooter').classList.add('hidden');
        chargerIdentifiants();
        loadAppCredit();
        loadLogoFromCode();
      };

      function loadAppCredit(){
        document.getElementById('appCredit').textContent = 'PCELEC';
      }
      function loadLogoFromCode() {
        if (typeof google === 'undefined' || !google.script || !google.script.run) return;
        google.script.run.withSuccessHandler(function(url){
          if (!url) return;
          const img = document.getElementById('appLogo');
          if (!img) return;
          img.src = url;
          img.style.display = 'inline-block';
        }).withFailureHandler(function(err){
          console.error('Erreur chargement logo depuis Code.gs :', err);
        }).getLogoUrlDirect();
      }

      function chargerIdentifiants(){
        clearAllErrors();
        const sel = document.getElementById('login');
        sel.innerHTML = '<option>Chargement...</option>';
        google.script.run.withSuccessHandler(function(list){
          sel.innerHTML = '';
          if (!list || list.length === 0) {
            const opt=document.createElement('option'); opt.textContent='-- Aucun identifiant --'; sel.appendChild(opt); return;
          }
          const def=document.createElement('option'); def.value=''; def.textContent='-- Choisir --'; sel.appendChild(def);
          list.forEach(function(id){ const opt = document.createElement('option'); opt.value = id; opt.textContent = id; sel.appendChild(opt); });
        }).withFailureHandler(function(){ sel.innerHTML='<option>Erreur</option>'; showError('login','Erreur chargement identifiants'); }).getIdentifiants();

        google.script.run.withSuccessHandler(function(list){
          campingsAffaires = list || [];
        }).withFailureHandler(function(err){ console.error(err); }).getCampingsEtAffaires();
      }

      function seConnecter(){
        clearAllErrors();
        const login = document.getElementById('login').value;
        const pass = document.getElementById('password').value;
        const loginMsg = document.getElementById('login-msg');
        if (!login) { if(loginMsg){ loginMsg.textContent='Sélectionne un identifiant.'; loginMsg.style.display = 'block'; } return; }
        google.script.run.withSuccessHandler(function(ok){
          if (ok) {
            currentUser = login;
            document.getElementById('page-login').classList.add('hidden');
            document.getElementById('page-form').classList.remove('hidden');
            document.getElementById('fixedFooter').classList.remove('hidden');
            document.getElementById('userLabel').textContent = currentUser;
            google.script.run.withSuccessHandler(function(m){
              currentMatricule = m || '';
              document.getElementById('matriculeDisplay').textContent = currentMatricule ? ('Matricule: ' + currentMatricule) : '';
            }).getMatriculeForName(currentUser);
          } else {
            if(loginMsg){ loginMsg.textContent='Mot de passe incorrect'; loginMsg.style.display='block'; }
          }
        }).withFailureHandler(function(){ if(loginMsg){ loginMsg.textContent='Erreur vérification'; loginMsg.style.display='block'; } }).checkLogin(login, pass);
      }

      function ajouterInterimaire(prefill){
        const tpl = document.getElementById('interimTpl');
        const n = tpl.content.cloneNode(true);
        const container = document.getElementById('interimContainer');
        container.appendChild(n);
        const block = container.lastElementChild;
        const sel = block.querySelector('.it_camping');
        sel.innerHTML = '<option value="">-- Choisir --</option>';
        const uniq=[...new Set((campingsAffaires||[]).map(o=>o.camping))];
        uniq.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
        renumberInterimaires();
        if(prefill){
          if(prefill.nom) block.querySelector('.it_nom').value = prefill.nom;
          if(prefill.camping) block.querySelector('.it_camping').value = prefill.camping;
          majAffairesInterimaireBlock(sel);
          if(prefill.affaire) block.querySelector('.it_affaire').value = prefill.affaire;
          if(prefill.tache) block.querySelector('.it_tache').value = prefill.tache;
          if(prefill.heureDebut) block.querySelector('.it_debut').value = prefill.heureDebut;
          if(prefill.heureFin) block.querySelector('.it_fin').value = prefill.heureFin;
        }
      }
      function supprimerInterimaire(btn){ const block = btn.closest('.interim-block'); if(block) { block.remove(); renumberInterimaires(); } }
      function viderInterimaires(){ document.getElementById('interimContainer').innerHTML = ''; }

      function renumberInterimaires(){
        const blocks = Array.from(document.querySelectorAll('#interimContainer .interim-block'));
        blocks.forEach((b,i)=>{ const t = b.querySelector('.interim-title'); if(t) t.textContent = 'Intérimaire ' + (i+1); });
      }

      function majAffairesInterimaireBlock(el){
        const block = el.closest('.interim-block');
        const affSel = block.querySelector('.it_affaire');
        affSel.innerHTML = '<option value="">-- Choisir --</option>';
        (campingsAffaires||[]).filter(o=>o.camping===el.value).forEach(o=>{ const opt=document.createElement('option'); opt.value=o.affaire; opt.textContent=o.affaire; affSel.appendChild(opt); });
      }
function scrollIntoViewIfNeeded(el){
  if (!el) return;
  const rect = el.getBoundingClientRect();
  const vh = window.innerHeight || document.documentElement.clientHeight;
  if (rect.top < 0 || rect.bottom > vh){
    el.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
  }
}
      function ajouterChantier(prefill){
        document.getElementById('loadingIndicator').style.display = 'inline';
        document.querySelectorAll('.entry-actions button').forEach(btn => btn.disabled = true);

        const tpl = document.getElementById('chantierTpl');
        const n = tpl.content.cloneNode(true);
        const container = document.getElementById('entriesContainer');
        container.appendChild(n);
        const block = container.lastElementChild;
        const sel = block.querySelector('.mc_camping');
        sel.innerHTML = '<option value="">-- Choisir --</option>';
        const uniq = [...new Set((campingsAffaires||[]).map(o=>o.camping))];
        uniq.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
        renumberEntries();
scrollIntoViewIfNeeded(block);
        document.getElementById('loadingIndicator').style.display = 'none';
        document.querySelectorAll('.entry-actions button').forEach(btn => btn.disabled = false);
        if (prefill) {
          if (prefill.camping) block.querySelector('.mc_camping').value = prefill.camping;
          majAffairesChantier(block.querySelector('.mc_camping'));
          if (prefill.affaire) block.querySelector('.mc_affaire').value = prefill.affaire;
          if (prefill.tache) block.querySelector('.mc_tache').value = prefill.tache;
          if (prefill.heureDebut) block.querySelector('.mc_heureDebut').value = prefill.heureDebut;
          if (prefill.heureFin) block.querySelector('.mc_heureFin').value = prefill.heureFin;
        }
      }
      function ajouterDeplacement(prefill){
        document.getElementById('loadingIndicator').style.display = 'inline';
        document.querySelectorAll('.entry-actions button').forEach(btn => btn.disabled = true);

        const tpl = document.getElementById('deplacementTpl');
        const n = tpl.content.cloneNode(true);
        const container = document.getElementById('entriesContainer');
        container.appendChild(n);
        const block = container.lastElementChild;
        renumberEntries();
scrollIntoViewIfNeeded(block);
        document.getElementById('loadingIndicator').style.display = 'none';
        document.querySelectorAll('.entry-actions button').forEach(btn => btn.disabled = false);
        if(prefill){
          block.querySelector('.dtype').value = prefill.type || 'domicile';
          block.querySelector('.d-debut').value = prefill.heureDebut || '';
          block.querySelector('.d-fin').value = prefill.heureFin || '';
          block.querySelector('.d-comment').value = prefill.commentaire || '';
        }
      }
      function supprimerEntry(btn){ const block = btn.closest('.chantier-block, .deplacement-block'); if(block) { block.remove(); renumberEntries(); } }

      function renumberEntries(){
        const container = document.getElementById('entriesContainer');
        const blocks = Array.from(container.querySelectorAll('.chantier-block, .deplacement-block'));
        let chantierCount = 0;
        let deplacementCount = 0;
        blocks.forEach((b) => {
          if (b.classList.contains('chantier-block')) {
            chantierCount++;
            const t = b.querySelector('.chantier-title');
            if (t) t.textContent = 'Chantier ' + chantierCount;
          } else if (b.classList.contains('deplacement-block')) {
            deplacementCount++;
            const t = b.querySelector('.deplacement-title');
            if (t) t.textContent = 'Déplacement ' + deplacementCount;
          }
        });
      }

      function majAffairesChantier(el){
        const block = el.closest('.chantier-block');
        const affSel = block.querySelector('.mc_affaire');
        affSel.innerHTML = '<option value="">-- Choisir --</option>';
        (campingsAffaires||[]).filter(o=>o.camping===el.value).forEach(o=>{ const opt=document.createElement('option'); opt.value=o.affaire; opt.textContent=o.affaire; affSel.appendChild(opt); });
      }
      function ajouterPauseChantier(btnOrBlock){
        let block = null;
        if (btnOrBlock && btnOrBlock.closest) block = btnOrBlock.closest('.chantier-block');
        if (!block && btnOrBlock && btnOrBlock.classList && btnOrBlock.classList.contains('chantier-block')) block = btnOrBlock;
        if(!block) return;
        if(block.querySelector('.mc_pause_block')) {
          block.querySelector('.mc_pause_block').style.display = 'block';
          return;
        }
        const div = document.createElement('div');
        div.className='mc_pause_block';
        div.innerHTML = `
          <label>Pause début
            <input type="time" class="mc_heurePause">
          </label>
          <div class="error-text mc_err_pause" style="display:none;"></div>
          <label>Pause fin
            <input type="time" class="mc_heureReprise">
          </label>
          <div class="error-text mc_err_reprise" style="display:none;"></div>
        `;
        block.appendChild(div);
      }

      function clearAllErrors(){ document.querySelectorAll('.error-text').forEach(e=>{ e.textContent=''; e.style.display='none'; }); document.getElementById('msg').textContent=''; document.getElementById('transferStatus').textContent=''; document.getElementById('transferStatus').className='status-text'; document.getElementById('btnValider').disabled = false; }
      function showError(id, msg){ const el = document.getElementById('err_' + id); if(!el) return; el.textContent = msg||''; el.style.display = msg ? 'block' : 'none'; }
      function showMsg(text){ const el = document.getElementById('msg'); el.textContent = text || ''; if(!text) el.style.display='none'; else el.style.display='block'; setTimeout(()=>{ el.textContent=''; },4000); }

      function setTransferStatus(text, ok){
        const el = document.getElementById('transferStatus');
        el.textContent = text || '';
        if (ok === true) { el.className = 'status-text status-green'; }
        else if (ok === false) { el.className = 'status-text status-red'; }
        else { el.className = 'status-text'; }
      }

      function majTypePersonne(){
        clearAllErrors();
        const t = document.getElementById('typePersonne').value;
        const formSections = document.getElementById('form-sections');
        if (t) {
          formSections.classList.remove('hidden');
          document.getElementById('bloc-interimaire').classList.toggle('hidden', t !== 'interimaire');
          document.getElementById('entries-section').classList.toggle('hidden', t === 'interimaire');
          if(t === 'interimaire' && !document.getElementById('interimContainer').children.length) ajouterInterimaire();
        } else {
          formSections.classList.add('hidden');
        }
      }

      function valider(){
        clearAllErrors();
        setTransferStatus('TRANSFERT EN COURS', true);
        document.getElementById('btnValider').disabled = true;

        if(!currentUser){ setTransferStatus('', null); showError('global','Aucun utilisateur connecté.'); document.getElementById('btnValider').disabled = false; return; }
        const type = document.getElementById('typePersonne').value;
        if(!type){ setTransferStatus('', null); showError('typePersonne','Requis'); document.getElementById('btnValider').disabled = false; return; }

        if (type === 'interimaire') {
          const blocks = Array.from(document.querySelectorAll('#interimContainer .interim-block'));
          if (blocks.length === 0) { setTransferStatus('', null); showError('entries','Au moins un intérimaire requis'); document.getElementById('btnValider').disabled = false; return; }

          const entries = [];
          let ok = true;
          blocks.forEach((b, idx) => {
            const nom = b.querySelector('.it_nom').value.trim();
            const camping = b.querySelector('.it_camping').value;
            const affaire = b.querySelector('.it_affaire').value;
            const debut = b.querySelector('.it_debut').value;
            const fin = b.querySelector('.it_fin').value;
            const tache = b.querySelector('.it_tache').value.trim();

            if(!nom){ const e=b.querySelector('.it_err_nom'); e.textContent='Requis'; e.style.display='block'; ok = false; }
            if(!camping){ const e=b.querySelector('.it_err_camping'); e.textContent='Requis'; e.style.display='block'; ok = false; }
            if(!affaire){ const e=b.querySelector('.it_err_affaire'); e.textContent='Requis'; e.style.display='block'; ok = false; }
            if(!debut){ const e=b.querySelector('.it_err_debut'); e.textContent='Requis'; e.style.display='block'; ok = false; }
            if(!fin){ const e=b.querySelector('.it_err_fin'); e.textContent='Requis'; e.style.display='block'; ok = false; }

            entries.push({ nom, camping, affaire, heureDebut: debut, heureFin: fin, commentaire: tache });
          });

          if(!ok){ setTransferStatus('', null); document.getElementById('btnValider').disabled = false; return; }

          let success = 0, fail = 0;
          function sendNext(i){
            if (i >= entries.length) {
              if (fail === 0) setTransferStatus('ENREGISTRÉ', true);
              else setTransferStatus('ERREUR (' + fail + ')', false);
              showMsg('Terminé : ' + success + ' réussis, ' + fail + ' échecs.');
              document.getElementById('btnValider').disabled = false;
              setTimeout(()=>{ setTransferStatus('', null); }, 2500);
              reinitialiserFormulaire();
              return;
            }
            const en = entries[i];
            const payload = {
              nom: en.nom,
              typePersonne: 'interimaire',
              entries: [{
                type: 'chantier',
                camping: en.camping,
                affaire: en.affaire,
                heureDebut: en.heureDebut,
                heurePause: '',
                heureReprise: '',
                heureFin: en.heureFin,
                commentaire: en.commentaire || ''
              }]
            };
            google.script.run.withSuccessHandler(function(count){
              success++;
              sendNext(i+1);
            }).withFailureHandler(function(err){
              fail++;
              console.error('Erreur envoi intérimaire', en.nom, err);
              sendNext(i+1);
            }).enregistrerPointageV2(payload);
          }
          sendNext(0);
          return;
        }

        const entryBlocks = Array.from(document.querySelectorAll('#entriesContainer .chantier-block, #entriesContainer .deplacement-block'));
        if(entryBlocks.length === 0){ setTransferStatus('', null); showError('entries','Au moins une entrée requise'); document.getElementById('btnValider').disabled = false; return; }

        const entries = [];
        let ok = true;
        entryBlocks.forEach((b) => {
          const isChantier = b.classList.contains('chantier-block');
          if (isChantier) {
            const camping = b.querySelector('.mc_camping').value;
            const affaire = b.querySelector('.mc_affaire').value;
            const tache = b.querySelector('.mc_tache').value.trim();
            const debut = b.querySelector('.mc_heureDebut').value;
            const fin = b.querySelector('.mc_heureFin').value;
            const pauseEl = b.querySelector('.mc_heurePause');
            const repriseEl = b.querySelector('.mc_heureReprise');
            let pause = '', reprise = '';
            if (pauseEl && repriseEl) { pause = pauseEl.value; reprise = repriseEl.value; }

            if(!camping){ const e=b.querySelector('.mc_err_camping'); e.textContent='Requis'; e.style.display='block'; ok=false; }
            if(!affaire){ const e=b.querySelector('.mc_err_affaire'); e.textContent='Requis'; e.style.display='block'; ok=false; }
            if(!tache){ const e=b.querySelector('.mc_err_tache'); e.textContent='Requis'; e.style.display='block'; ok=false; }
            if(!debut){ const e=b.querySelector('.mc_err_debut'); e.textContent='Requis'; e.style.display='block'; ok=false; }
            if(!fin){ const e=b.querySelector('.mc_err_fin'); e.textContent='Requis'; e.style.display='block'; ok=false; }
            if(pauseEl && !pause){ const e=b.querySelector('.mc_err_pause'); e.textContent='Requis'; e.style.display='block'; ok=false; }
            if(repriseEl && !reprise){ const e=b.querySelector('.mc_err_reprise'); e.textContent='Requis'; e.style.display='block'; ok=false; }

            entries.push({
              type: 'chantier',
              camping: camping,
              affaire: affaire,
              heureDebut: debut,
              heurePause: pause,
              heureReprise: reprise,
              heureFin: fin,
              commentaire: tache
            });
          } else {
            const dtype = b.querySelector('.dtype').value;
            const comment = b.querySelector('.d-comment').value.trim();
            const debut = b.querySelector('.d-debut').value;
            const fin = b.querySelector('.d-fin').value;

            if(!comment){ const e=b.querySelector('.d_err_comment'); e.textContent='Requis'; e.style.display='block'; ok = false; }
            if(!debut){ const e=b.querySelector('.d_err_debut'); e.textContent='Requis'; e.style.display='block'; ok = false; }
            if(!fin){ const e=b.querySelector('.d_err_fin'); e.textContent='Requis'; e.style.display='block'; ok = false; }

            entries.push({
              type: 'deplacement',
              dtype: dtype,
              heureDebut: debut,
              heureFin: fin,
              commentaire: comment
            });
          }
        });
        if(!ok){ setTransferStatus('', null); document.getElementById('btnValider').disabled = false; return; }

        const payload = {
          nom: currentUser,
          typePersonne: type,
          entries: entries
        };

        google.script.run.withSuccessHandler(function(count){
          setTransferStatus('ENREGISTRÉ', true);
          showMsg('Enregistré (' + count + ' lignes ajoutées)');
          reinitialiserFormulaire();
          document.getElementById('btnValider').disabled = false;
          setTimeout(()=>{ setTransferStatus('', null); }, 2500);
        }).withFailureHandler(function(err){
          setTransferStatus('ERREUR', false);
          showError('global','Erreur serveur: ' + (err && err.message ? err.message : 'Erreur'));
          console.error(err);
          document.getElementById('btnValider').disabled = false;
        }).enregistrerPointageV2(payload);
      }

      function reinitialiserFormulaire(){
        document.getElementById('typePersonne').value = '';
        document.getElementById('form-sections').classList.add('hidden');
        document.getElementById('entriesContainer').innerHTML = '';
        document.getElementById('interimContainer').innerHTML = '';
        clearAllErrors();
      }

      function afficherHistorique(){
        const meta = document.querySelector('meta[name="viewport"]');
        if (meta) meta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=yes');
        const panel=document.getElementById('historyPanel');
        panel.style.display='block';
        panel.setAttribute('aria-hidden','false');
        if(cachedHistory){
          renderHistory(cachedHistory);
          document.getElementById('fixedFooter').style.display = 'none';
          return;
        }
        document.getElementById('historyContent').innerHTML='<div class="muted">Chargement...</div>';
        google.script.run
          .withSuccessHandler(function(){ callHistorique(); })
          .withFailureHandler(function(e){
            renderHistory([]);
            showError('global', 'Erreur de connexion au serveur.');
            setTimeout(() => showError('global', ''), 5000);
          })
          .testPing();
        document.getElementById('fixedFooter').style.display = 'none';
      }

      function callHistorique(){
        google.script.run
          .withSuccessHandler(function(data){
            cachedHistory=data;
            renderHistory(data);
          })
          .withFailureHandler(function(err){
            renderHistory([]);
            showError('global', 'Erreur chargement historique : ' + (err && err.message ? err.message : 'Erreur inconnue'));
            setTimeout(() => showError('global', ''), 5000);
          })
          .getHistoriquePointages();
      }

      function renderHistory(data){
  const content=document.getElementById('historyContent');
  if(!data||data.length===0){ content.innerHTML='<div>Aucun historique.</div>'; return;}
  let html='<div class="h-scrollbar"><div class="h-scrollbar-inner"></div></div>';
  html+='<div class="table-wrap"><table><thead><tr>';
  const header=data[0];
  header.forEach(h=>html+='<th>'+escapeHtml(h||'')+'</th>');
  html+='</tr></thead><tbody>';
  for(let i=1;i<data.length;i++){
    html+='<tr>';
    data[i].forEach(c=>html+='<td>'+escapeHtml(c||'')+'</td>');
    html+='</tr>';
  }
  html+='</tbody></table><div style="height:200px;"></div></div>';
  content.innerHTML=html;

  // synchro des scrolls
  const wrap = content.querySelector('.table-wrap');
  const hsb  = content.querySelector('.h-scrollbar');
  const hsbInner = content.querySelector('.h-scrollbar-inner');
  if (wrap && hsb && hsbInner) {
    hsbInner.style.width = wrap.scrollWidth + 'px';
    hsb.scrollLeft = wrap.scrollLeft;
    hsb.addEventListener('scroll', () => { wrap.scrollLeft = hsb.scrollLeft; });
    wrap.addEventListener('scroll', () => { hsb.scrollLeft = wrap.scrollLeft; });
  }
}

      function fermerHistorique(){
        const meta = document.querySelector('meta[name="viewport"]');
        if (meta) meta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=no');
        const panel=document.getElementById('historyPanel');
        panel.style.display='none';
        panel.setAttribute('aria-hidden','true');
        document.getElementById('fixedFooter').style.display = 'flex';
      }
      function telechargerCSV(){
        if(!cachedHistory||cachedHistory.length===0){
          showError('global','Aucun historique');
          setTimeout(()=>showError('global',''),3000);
          return;
        }
        const rows=cachedHistory.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(','));
        const csv=rows.join('\r\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='historique_pointages.csv';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); showMsg('CSV téléchargé'); },3000);
      }
      function telechargerPDF(){
        const btn=document.getElementById('btnExportPDF');
        if(btn){btn.disabled=true;btn.textContent='Génération PDF...';}
        google.script.run.withSuccessHandler(function(url){
          if(btn){btn.disabled=false;btn.textContent='Exporter PDF';}
          if(!url){
            showError('global','Erreur génération PDF');
            setTimeout(()=>showError('global',''),3000);
            return;
          }
          window.open(url,'_blank');
          showMsg('PDF généré');
        }).withFailureHandler(function(err){
          if(btn){btn.disabled=false;btn.textContent='Exporter PDF';}
          showError('global','Erreur génération PDF');
          setTimeout(()=>showError('global',''),3000);
        }).exportHistoriquePDF();
      }

      function escapeHtml(s){
        return String(s)
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
      }

      window.ajouterInterimaire = ajouterInterimaire;
      window.viderInterimaires = viderInterimaires;
      window.supprimerInterimaire = supprimerInterimaire;
      window.majAffairesInterimaireBlock = majAffairesInterimaireBlock;
      window.ajouterChantier = ajouterChantier;
      window.ajouterDeplacement = ajouterDeplacement;
      window.supprimerEntry = supprimerEntry;
      window.majAffairesChantier = majAffairesChantier;
    </script>
  </body>
</html>